syntax = "proto3";

package terrabase.auth.v1;

import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "terrabase/user/v1/user.proto";
import "terrabase/user_role/v1/user_role.proto";

option go_package = "github.com/terrabase-dev/terrabase/specs/terrabase/auth/v1;authv1";

/*
 #######################
 # User authentication #
 #######################
*/
message SignupRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED];
  string email = 2 [(google.api.field_behavior) = REQUIRED];
  string password = 3 [(google.api.field_behavior) = REQUIRED];
  terrabase.user_role.v1.UserRole default_role = 4 [(google.api.field_behavior) = REQUIRED];
}

message SignupResponse {
  terrabase.user.v1.User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

message LoginRequest {
  string email = 1 [(google.api.field_behavior) = REQUIRED];
  string password = 2 [(google.api.field_behavior) = REQUIRED];
}

message LoginResponse {
  terrabase.user.v1.User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

message RefreshRequest {
  string refresh_token = 1 [(google.api.field_behavior) = REQUIRED];
}

message RefreshResponse {
  string access_token = 1;
  string refresh_token = 2;
}

message WhoAmIRequest {}

message WhoAmIResponse {
  terrabase.user.v1.User user = 1;
  repeated string scopes = 2;
}

message LogoutRequest {
  string session_id = 1; // if empty, use current access token jti
}

message LogoutResponse {}

/*
 #################
 # Machine users #
 #################
*/
message CreateMachineUserRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED];
  terrabase.user_role.v1.UserRole default_role = 2 [(google.api.field_behavior) = REQUIRED];
  terrabase.user.v1.UserType user_type = 3 [(google.api.field_behavior) = REQUIRED];
  string owner_user_id = 4 [(google.api.field_behavior) = REQUIRED];
}

message CreateMachineUserResponse {
  terrabase.user.v1.User machine_user = 1;
}

/*
 ############
 # API keys #
 ############
*/
enum ApiKeyOwnerType {
  API_KEY_OWNER_TYPE_UNSPECIFIED = 0;
  API_KEY_OWNER_TYPE_USER = 1;
  API_KEY_OWNER_TYPE_BOT = 2;
  API_KEY_OWNER_TYPE_SERVICE = 3;
}

message ApiKey {
  string id = 1;
  string name = 2;
  repeated string scopes = 3;
  string owner_id = 4;
  ApiKeyOwnerType owner_type = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp expires_at = 7;
  google.protobuf.Timestamp last_used_at = 8;
  google.protobuf.Timestamp revoked_at = 9;
}

message CreateApiKeyRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED];
  ApiKeyOwnerType owner_type = 2 [(google.api.field_behavior) = REQUIRED];
  string owner_id = 3 [(google.api.field_behavior) = REQUIRED];
  repeated string scopes = 4 [(google.api.field_behavior) = REQUIRED];
  // Hours until expiry; if unset, key does not expire.
  optional int64 ttl_hours = 5;
}

message CreateApiKeyResponse {
  string api_key_token = 1;
  ApiKey api_key = 2;
}

message ListApiKeysRequest {
  ApiKeyOwnerType owner_type = 1;
  string owner_id = 2;
}

message ListApiKeysResponse {
  repeated ApiKey api_keys = 1;
}

message RevokeApiKeyRequest {
  string id = 1 [(google.api.field_behavior) = REQUIRED];
  string reason = 2;
}

message RevokeApiKeyResponse {}

message RotateApiKeyRequest {
  string id = 1 [(google.api.field_behavior) = REQUIRED];
  // Optional: inherit existing scopes and ttl when unset.
  repeated string scopes = 2;
  optional int64 ttl_hours = 3;
}

message RotateApiKeyResponse {
  string api_key_token = 1;
  ApiKey api_key = 2;
}

message Session {
  string id = 1;
  string user_agent = 2;
  string ip = 3;
  google.protobuf.Timestamp expires_at = 4;
  google.protobuf.Timestamp last_used_at = 5;
  google.protobuf.Timestamp created_at = 6;
}

message ListSessionsRequest {}

message ListSessionsResponse {
  repeated Session sessions = 1;
}

service AuthService {
  rpc Signup(SignupRequest) returns (SignupResponse);
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc Refresh(RefreshRequest) returns (RefreshResponse);
  rpc WhoAmI(WhoAmIRequest) returns (WhoAmIResponse);
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse);

  rpc CreateMachineUser(CreateMachineUserRequest) returns (CreateMachineUserResponse);

  rpc CreateApiKey(CreateApiKeyRequest) returns (CreateApiKeyResponse);
  rpc ListApiKeys(ListApiKeysRequest) returns (ListApiKeysResponse);
  rpc RevokeApiKey(RevokeApiKeyRequest) returns (RevokeApiKeyResponse);
  rpc RotateApiKey(RotateApiKeyRequest) returns (RotateApiKeyResponse);
}
