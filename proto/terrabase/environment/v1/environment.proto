syntax = "proto3";

package terrabase.environment.v1;

import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "terrabase/authz/v1/authz.proto";
import "terrabase/workspace/v1/workspace.proto";

option go_package = "github.com/terrabase-dev/terrabase/specs/terrabase/environment/v1;environmentv1";

// A Terrabase environment is a business environment that an application is deployed in
message Environment {
  // The unique ID of the environment
  string id = 1;

  // The name of the environment
  string name = 2;

  // The ID of the application this environment belongs to
  string application_id = 3;

  // The time the environment was created
  google.protobuf.Timestamp created_at = 4;

  // The time the environment was last updated at
  google.protobuf.Timestamp updated_at = 5;
}

message CreateEnvironmentRequest {
  // The name of the environment
  string name = 1 [(google.api.field_behavior) = REQUIRED];

  // The ID of the application the environment belongs to
  string application_id = 2 [(google.api.field_behavior) = REQUIRED];

  // The configuration for the workspace that belongs to this environment
  terrabase.workspace.v1.CreateWorkspaceRequest new_workspace = 3;
}

message CreateEnvironmentResponse {
  // The environment that was created
  Environment environment = 1;
}

message GetEnvironmentRequest {
  // The unique ID of the environment
  string id = 1 [(google.api.field_behavior) = REQUIRED];
}

message GetEnvironmentResponse {
  // The environment
  Environment environment = 1;
}

message ListEnvironmentsRequest {
  // The ID of the application to list environments for
  string application_id = 1 [(google.api.field_behavior) = REQUIRED];
}

message ListEnvironmentsResponse {
  // A list of environments
  repeated Environment environments = 1;
}

message UpdateEnvironmentRequest {
  // The unique ID of the environment to update
  string id = 1 [(google.api.field_behavior) = REQUIRED];

  // The new name of the environment
  optional string name = 2;
}

message UpdateEnvironmentResponse {
  // The updated environment
  Environment environment = 1;
}

message DeleteEnvironmentRequest {
  // The unique ID of the environment to delete
  string id = 1 [(google.api.field_behavior) = REQUIRED];
}

message DeleteEnvironmentResponse {}

service EnvironmentService {
  // Create a new environment
  rpc CreateEnvironment(CreateEnvironmentRequest) returns (CreateEnvironmentResponse) {
    option (terrabase.authz.v1.auth_required) = true;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ADMIN;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_WRITE;
  }

  // Retrieve details about a specific environment
  rpc GetEnvironment(GetEnvironmentRequest) returns (GetEnvironmentResponse) {
    option (terrabase.authz.v1.auth_required) = true;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ADMIN;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_READ;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_WRITE;
  }

  // List environments that belong to an application
  rpc ListEnvironments(ListEnvironmentsRequest) returns (ListEnvironmentsResponse) {
    option (terrabase.authz.v1.auth_required) = true;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ADMIN;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_READ;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_WRITE;
  }

  // Change details about an environment
  rpc UpdateEnvironment(UpdateEnvironmentRequest) returns (UpdateEnvironmentResponse) {
    option (terrabase.authz.v1.auth_required) = true;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ADMIN;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_WRITE;
  }

  // Delete an environment
  rpc DeleteEnvironment(DeleteEnvironmentRequest) returns (DeleteEnvironmentResponse) {
    option (terrabase.authz.v1.auth_required) = true;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ADMIN;
    option (terrabase.authz.v1.required_scopes) = SCOPE_ENVIRONMENT_WRITE;
  }
}
